<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shared Chat + Device Requests</title>
<style>
  :root{--bg:#0f1724;--card:rgba(255,255,255,0.05);--accent:#ff6b3d}
  body{margin:0;font-family:Segoe UI,Arial;background:linear-gradient(135deg,var(--bg),#243447);color:#fff;display:flex;justify-content:center;padding:28px}
  .wrap{width:100%;max-width:980px;display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  header{grid-column:1/-1;text-align:center;margin-bottom:6px}
  h1{margin:0;font-size:18px}
  /* left chat */
  #chatWindow{height:560px;display:flex;flex-direction:column}
  #messages{flex:1;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.04))}
  .msg{max-width:78%;padding:8px 12px;margin:8px 0;border-radius:10px}
  .me{margin-left:auto;background:linear-gradient(180deg,var(--accent),#ff5422)}
  .who{background:rgba(255,255,255,0.06)}
  #controls{display:flex;gap:10px;margin-top:10px}
  input[type=text]{flex:1;padding:10px;border-radius:8px;border:none}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  /* right column */
  .section{margin-bottom:12px}
  .req{padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:13px;color:rgba(255,255,255,0.7)}
  .chip{background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:20px}
  .connected{color:lightgreen}
  footer{grid-column:1/-1;text-align:center;padding-top:12px;color:rgba(255,255,255,0.6)}
  @media(max-width:900px){.wrap{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <div class="wrap">
    <header class="card"><h1>Unified Chat — web ↔ device requests</h1></header>

    <div class="card" id="chatWindow">
      <div class="small">API status: <span id="apiStatus">unknown</span></div>
      <div id="messages"></div>

      <div id="controls">
        <input id="txt" type="text" placeholder="Type message..." />
        <button id="send">Send</button>
        <button id="refresh">Refresh</button>
      </div>
    </div>

    <div class="card">
      <div class="section">
        <div class="small">Connected devices</div>
        <div id="devicesList"></div>
      </div>

      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Pending connection requests</div>
          <button id="reloadReq" class="chip">Reload</button>
        </div>
        <div id="requestsList" style="margin-top:8px"></div>
      </div>

      <div class="section">
        <div class="small">Quick actions</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="checkApi">Check API</button>
          <button id="clearMessages">Clear (local)</button>
        </div>
      </div>
    </div>

    <footer class="small">Server API designed for local/dev use. Replace <code>API_BASE</code> to deployed URL.</footer>
  </div>

<script>
  // ======= CONFIG =======
  const API_BASE = "http://localhost:5000"; // change to deployed URL if hosted

  // ======= HELPERS =======
  const el = id => document.getElementById(id);
  const messagesDiv = el('messages'), devicesDiv = el('devicesList'), requestsDiv = el('requestsList');
  const apiStatus = el('apiStatus');

  function append(msgObj){
    const d = document.createElement('div');
    d.className = 'msg ' + (msgObj.from === 'Website' ? 'me' : 'who');
    d.innerHTML = `<strong>${escapeHtml(msgObj.from)}</strong>: ${escapeHtml(msgObj.text)} <div class="small">${new Date(msgObj.time||msgObj.time).toLocaleTimeString()}</div>`;
    messagesDiv.appendChild(d);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  // ======= API calls =======
  async function checkApi(){
    apiStatus.textContent = 'checking...';
    try{
      const r = await fetch(API_BASE + '/api/check');
      if(!r.ok) throw new Error(r.status);
      const j = await r.json();
      apiStatus.textContent = 'OK (' + new Date(j.time).toLocaleTimeString() + ')';
      apiStatus.style.color = 'lightgreen';
    }catch(e){
      apiStatus.textContent = 'offline';
      apiStatus.style.color = 'salmon';
    }
  }

  async function loadMessages(){
    try{
      const r = await fetch(API_BASE + '/api/messages');
      const arr = await r.json();
      messagesDiv.innerHTML = '';
      arr.forEach(m=> append(m));
    }catch(e){
      console.error(e);
    }
  }

  async function sendMessage(text){
    try{
      await fetch(API_BASE + '/api/messages', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ from: 'Website', text })
      });
      await loadMessages();
    }catch(e){
      append({ from:'System', text:'Error sending: '+e.message, time:new Date().toISOString() });
    }
  }

  async function loadDevices(){
    try{
      const r = await fetch(API_BASE + '/api/devices');
      const arr = await r.json();
      devicesDiv.innerHTML = '';
      arr.forEach(d=>{
        const el = document.createElement('div');
        el.className = 'small';
        el.innerHTML = `${d.name} <span class="${d.connected? 'connected':'small'}">[${d.connected? 'connected':'not connected'}]</span>`;
        devicesDiv.appendChild(el);
      });
    }catch(e){}
  }

  async function loadRequests(){
    try{
      const r = await fetch(API_BASE + '/api/requests');
      const arr = await r.json();
      requestsDiv.innerHTML = '';
      if(arr.length===0){ requestsDiv.innerHTML = '<div class="small">No requests</div>'; return; }
      arr.forEach(req=>{
        const row = document.createElement('div');
        row.className = 'req';
        row.innerHTML = `<div><strong>${escapeHtml(req.name)}</strong><div class="small">${new Date(req.time).toLocaleString()}</div></div>
          <div>
            <button onclick="acceptRequest('${req.id}')">Accept</button>
          </div>`;
        requestsDiv.appendChild(row);
      });
    }catch(e){}
  }

  async function acceptRequest(requestId){
    try{
      const r = await fetch(API_BASE + '/api/accept', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ requestId })
      });
      const j = await r.json();
      if(j.ok){
        await loadRequests();
        await loadDevices();
        append({ from:'System', text:`Accepted device ${j.deviceId}`, time:new Date().toISOString() });
      } else {
        append({ from:'System', text:'Accept failed', time:new Date().toISOString() });
      }
    }catch(e){
      append({ from:'System', text:'Accept error: '+e.message, time:new Date().toISOString() });
    }
  }

  // ======= UI wiring =======
  el('send').addEventListener('click', ()=>{ const v = el('txt').value.trim(); if(!v) return; sendMessage(v); el('txt').value=''; });
  el('refresh').addEventListener('click', ()=> { loadMessages(); loadDevices(); loadRequests(); });
  el('checkApi').addEventListener('click', checkApi);
  el('reloadReq').addEventListener('click', loadRequests);
  el('clearMessages').addEventListener('click', ()=> { messagesDiv.innerHTML=''; });

  // auto refresh every 3.5s
  setInterval(()=>{ loadMessages(); loadDevices(); loadRequests(); }, 3500);

  // init
  checkApi();
  loadMessages();
  loadDevices();
  loadRequests();
</script>
</body>
</html>
